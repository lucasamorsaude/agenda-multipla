<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Superadmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .metric-card { border: none; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .table-hover tbody tr:hover { background-color: #e9ecef; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-shield-check text-danger"></i> Dashboard Superadmin</h2>
                <p class="text-muted">Análise consolidada de todas as unidades</p>
            </div>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Voltar ao Dashboard Padrão</a>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{{ url_for('superadmin.dashboard') }}" class="d-flex align-items-center">
                    <label for="selected_date" class="form-label me-2 mb-0"><strong>Visualizar Dia:</strong></label>
                    <input type="date" id="selected_date" name="selected_date" value="{{ selected_date }}" class="form-control me-2" style="width: auto;">
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                </form>
            </div>
        </div>

        <div class="row mb-4">
            <h4 class="mb-3">Indicadores Globais Consolidados</h4>
            
            <div class="col mb-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle text-muted">Agendamentos</h6>
                        <h3 class="card-title">{{ global_summary.total_agendado_geral }}</h3>
                    </div>
                </div>
            </div>
            <div class="col mb-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle text-muted">Atendimentos</h6>
                        <h3 class="card-title">{{ global_summary.total_atendidos_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(8, 180, 214);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Confirmação</h6>
                        <h3 class="card-title">{{ global_summary.taxa_confirmacao_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(233, 202, 26);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Ocupação</h6>
                        <h3 class="card-title">{{ global_summary.taxa_ocupacao_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(253, 141, 13);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Conversão</h6>
                        <h3 class="card-title">{{ global_summary.taxa_conversao_global }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card metric-card mb-4">
            <div class="card-header"><h4>Desempenho por Unidade</h4></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="unitsTable">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="cursor: pointer;">Unidade &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Agendamentos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Atendimentos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Confirmação &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Faltosos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Ocupação &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Conversão &#x21D5;</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for unit in units_stats %}
                            <tr>
                                <td><strong>{{ unit.name }}</strong></td>
                                <td>{{ unit.agendados }}</td>
                                <td>{{ unit.atendidos }}</td>
                                <td><span class="badge fs-6 rounded-pill text-bg-info">{{ unit.confirmacao }}</span></td>
                                <td><span class="text-danger fw-bold">{{ unit.nao_compareceu }}</span></td>
                                <td><span class="badge fs-6 rounded-pill text-bg-success">{{ unit.ocupacao }}</span></td>
                                <td><span class="badge fs-6 rounded-pill text-bg-primary">{{ unit.conversao }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

<script>
// JavaScript para ordenação da tabela (Ajuste 4)
const getCellValue = (tr, idx) => {
    const cell = tr.children[idx];
    const value = cell.innerText || cell.textContent;
    // Tenta converter para número, especialmente para porcentagens
    const num = parseFloat(value.replace(',', '.'));
    return isNaN(num) ? value.trim().toLowerCase() : num;
};

document.querySelectorAll('#unitsTable th').forEach(th => th.addEventListener('click', (() => {
    const table = th.closest('table');
    const tbody = table.querySelector('tbody');
    const column = Array.from(th.parentNode.children).indexOf(th);
    const dir = th.dataset.dir = -(th.dataset.dir || -1);

    Array.from(tbody.querySelectorAll('tr'))
        .sort((a, b) => (getCellValue(a, column) > getCellValue(b, column) ? 1 : -1) * dir)
        .forEach(tr => tbody.appendChild(tr));
})));


</script>
</body>
</html>