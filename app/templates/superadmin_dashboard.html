<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Superadmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/774/774134.png" type="image/x-icon">
    <style>
        body { background-color: #f0f2f5; }
        .metric-card { border: none; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .table-hover tbody tr:hover { background-color: #e9ecef; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-shield-check text-danger"></i> Dashboard Superadmin</h2>
                <p class="text-muted">Análise consolidada de todas as unidades</p>
            </div>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Voltar ao Dashboard Padrão</a>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{{ url_for('superadmin.dashboard') }}" class="d-flex align-items-center">
                    <label for="selected_date" class="form-label me-2 mb-0"><strong>Visualizar Dia:</strong></label>
                    <input type="date" id="selected_date" name="selected_date" value="{{ selected_date }}" class="form-control me-2" style="width: auto;">
                    <button type="submit" class="btn btn-primary">Ver resumo</button>

                    <button type="button" id="force-update-all-superadmin-btn" class="btn btn-outline-warning ms-3">Forçar Atualização de Todas</button>
                </form>
            </div>
        </div>

        <div class="row mb-4">
            <h4 class="mb-3">Indicadores Globais Consolidados</h4>
            
            <div class="col mb-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle text-muted">Agendamentos</h6>
                        <h3 class="card-title">{{ global_summary.total_agendado_geral }}</h3>
                    </div>
                </div>
            </div>
            <div class="col mb-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle text-muted">Atendimentos</h6>
                        <h3 class="card-title">{{ global_summary.total_atendidos_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(8, 180, 214);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Confirmação</h6>
                        <h3 class="card-title">{{ global_summary.taxa_confirmacao_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(233, 202, 26);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Ocupação</h6>
                        <h3 class="card-title">{{ global_summary.taxa_ocupacao_global }}</h3>
                    </div>
                </div>
            </div>
            
            <div class="col mb-3">
                <div class="card metric-card " style="background-color: rgb(253, 141, 13);">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle">Conversão</h6>
                        <h3 class="card-title">{{ global_summary.taxa_conversao_global }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card metric-card mb-4">
            <div class="card-header"><h4>Desempenho por Unidade</h4></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="unitsTable">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="cursor: pointer;">Unidade &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Agendamentos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Atendimentos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Confirmação &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Faltosos &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Ocupação &#x21D5;</th>
                                <th scope="col" style="cursor: pointer;">Conversão &#x21D5;</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for unit in units_stats %}
                            <tr>
                                <td><strong>{{ unit.name }}</strong></td>
                                <td>{{ unit.agendados }}</td>
                                <td>{{ unit.atendidos }}</td>

                                {% set percent = unit.confirmacao_numeric %}
                                {% if percent >= 80 %}{% set color = 'text-bg-success' %}
                                {% elif percent >= 60 %}{% set color = 'text-bg-warning' %}
                                {% else %}{% set color = 'text-bg-danger' %}{% endif %}
                                <td><span class="badge fs-6 rounded-pill {{ color }}">{{ unit.confirmacao }}</span></td>

                                <td><span class="text-danger fw-bold">{{ unit.nao_compareceu }}</span></td>

                                {% set percent = unit.ocupacao_numeric %}
                                {% if percent >= 80 %}{% set color = 'text-bg-success' %}
                                {% elif percent >= 60 %}{% set color = 'text-bg-warning' %}
                                {% else %}{% set color = 'text-bg-danger' %}{% endif %}
                                <td><span class="badge fs-6 rounded-pill {{ color }}">{{ unit.ocupacao }}</span></td>

                                {% set percent = unit.conversao_numeric %}
                                {% if percent >= 80 %}{% set color = 'text-bg-success' %}
                                {% elif percent >= 60 %}{% set color = 'text-bg-warning' %}
                                {% else %}{% set color = 'text-bg-danger' %}{% endif %}
                                <td><span class="badge fs-6 rounded-pill {{ color }}">{{ unit.conversao }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>


    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="updateToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Atualização de Cache</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body-message"></div>
        </div>
    </div>
    </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // JavaScript para ordenação da tabela
    const getCellValue = (tr, idx) => {
        const cell = tr.children[idx];
        const value = cell.innerText || cell.textContent;
        const num = parseFloat(value.replace(',', '.'));
        return isNaN(num) ? value.trim().toLowerCase() : num;
    };

    document.querySelectorAll('#unitsTable th').forEach(th => th.addEventListener('click', (() => {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const column = Array.from(th.parentNode.children).indexOf(th);
        const dir = th.dataset.dir = -(th.dataset.dir || -1);

        Array.from(tbody.querySelectorAll('tr'))
            .sort((a, b) => (getCellValue(a, column) > getCellValue(b, column) ? 1 : -1) * dir)
            .forEach(tr => tbody.appendChild(tr));
    })));

    // --- LÓGICA PARA FORÇAR ATUALIZAÇÃO DE TODAS AS UNIDADES ---
    const toastEl = document.getElementById('updateToast');
    const toast = new bootstrap.Toast(toastEl);
    const toastBody = document.getElementById('toast-body-message');
    const updateButton = document.getElementById('force-update-all-superadmin-btn');

    updateButton.addEventListener('click', async function() {
        this.disabled = true;
        const originalButtonText = this.innerHTML;
        
        try {
            const response = await fetch("{{ url_for('api.my_units_api') }}");
            if (!response.ok) throw new Error('Falha ao buscar lista de unidades.');
            const unitsToUpdate = await response.json();

            if (unitsToUpdate.length === 0) {
                throw new Error('Nenhuma unidade encontrada para atualizar.');
            }

            for (let i = 0; i < unitsToUpdate.length; i++) {
                const unit = unitsToUpdate[i];
                const progress = `(${i + 1}/${unitsToUpdate.length})`;
                this.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Atualizando ${unit.name} ${progress}`;
                
                const formData = new FormData();
                formData.append('selected_date_force_update', document.getElementById('selected_date').value);
                formData.append('unit_id', unit.id);

                const updateResponse = await fetch("{{ url_for('cache.force_update_day_cache_sync') }}", {
                    method: 'POST',
                    body: formData
                });
                const result = await updateResponse.json();

                if (result.status !== 'success') {
                    toastBody.textContent = result.message;
                    toast.show();
                }
            }

            this.innerHTML = 'Concluído!';
            toastBody.textContent = 'Todas as unidades foram atualizadas com sucesso. A página será recarregada.';
            toast.show();
            setTimeout(() => { window.location.reload(); }, 2500);

        } catch (error) {
            console.error('Erro no processo de atualização:', error);
            toastBody.textContent = error.message || 'Ocorreu um erro geral na atualização.';
            toast.show();
            this.disabled = false;
            this.innerHTML = originalButtonText;
        }
    });
</script>


</body>
</html>